"""
ARCO V3 - VULNERABILITY-DRIVEN OUTREACH ENGINE
Sistema de templates hiperpersonalizados baseado em vulnerabilidades espec√≠ficas detectadas
"""

import re
from typing import Dict, List, Optional
from datetime import datetime, timedelta

class VulnerabilityDrivenOutreachEngine:
    """
    üéØ ENGINE DE OUTREACH HIPERPERSONALIZADO
    
    Gera mensagens espec√≠ficas baseadas nas vulnerabilidades detectadas pelo DiscoveryAgent.
    Cada template √© personalizado para o tipo espec√≠fico de vulnerabilidade encontrada.
    """
    
    def __init__(self):
        # üéØ TEMPLATES ESPEC√çFICOS POR VULNERABILIDADE
        self.vulnerability_templates = {
            "emergency_claims_without_proof_system": {
                "hook": "Sua campanha '24/7 Emergency' est√° gerando complaints - aqui est√° o porqu√™",
                "problem_specific": "Vi sua campaign prometendo emergency response, mas sem tracking system p√∫blico. Isso significa:",
                "evidence": [
                    "‚Ä¢ Clientes ligam e n√£o conseguem verificar response time real",
                    "‚Ä¢ Competitors com tracking system est√£o convertendo melhor", 
                    "‚Ä¢ Google ads budget sendo desperdi√ßado em traffic que n√£o converte"
                ],
                "solution_specific": "Implemento: (1) Response time dashboard p√∫blico, (2) SMS tracking integration, (3) Landing page com real-time dispatcher status",
                "roi_specific": "Resultado: 35% aumento em conversion rate emergency calls + redu√ß√£o 28% em CAC",
                "urgency_trigger": "√âpoca de pico (ver√£o) come√ßando em 30 dias",
                "cta": "15 min para mostrar dashboard demo espec√≠fico para HVAC emergency",
                "industry": "HVAC"
            },
            
            "wait_time_promises_without_tracking": {
                "hook": "Pacientes est√£o reclamando de wait times maiores que prometido nas suas ads",
                "problem_specific": "Campaign 'No Wait Times' sem queue management = frustra√ß√£o + churn. Isso significa:",
                "evidence": [
                    "‚Ä¢ Pacientes chegam esperando 'no wait' e encontram fila",
                    "‚Ä¢ Google reviews negativas mencionando 'propaganda enganosa'",
                    "‚Ä¢ Ad spend sendo desperdi√ßado em expectativas que n√£o conseguem entregar"
                ],
                "solution_specific": "Implemento: (1) Real-time queue display, (2) SMS wait time updates, (3) Online check-in with accurate timing",
                "roi_specific": "Resultado: 42% redu√ß√£o em walk-outs + 23% aumento em patient satisfaction",
                "urgency_trigger": "Flu season chegando - volume vai triplicar",
                "cta": "Demo 10-min: queue management system funcionando em urgent care similar",
                "industry": "Healthcare"
            },
            
            "transformation_claims_without_tracking": {
                "hook": "Seus ads prometem transforma√ß√£o, mas prospects n√£o est√£o convertendo",
                "problem_specific": "Campaign 'Transform Your Body' sem progress tracking = baixa credibilidade. Isso significa:",
                "evidence": [
                    "‚Ä¢ Leads perguntam 'como voc√™s medem progresso?' e n√£o t√™m resposta clara",
                    "‚Ä¢ Before/after claims sem sistema de tracking sistem√°tico",
                    "‚Ä¢ Competitors com progress tracking est√£o roubando conversions"
                ],
                "solution_specific": "Implemento: (1) Progress tracking app integration, (2) Before/after photo system, (3) Results verification dashboard",
                "roi_specific": "Resultado: 31% aumento em sign-ups + 45% melhoria em member retention",
                "urgency_trigger": "Janeiro (New Year resolution season) em 4 meses",
                "cta": "Demo r√°pido: progress tracking system usado por fitness center similar",
                "industry": "Fitness"
            },
            
            "inventory_claims_without_real_time_data": {
                "hook": "Clientes chegam √† sua loja e os carros anunciados 'em estoque' n√£o est√£o dispon√≠veis",
                "problem_specific": "Campaign 'In Stock Now' sem inventory integration = leads frustrados. Isso significa:",
                "evidence": [
                    "‚Ä¢ Prospects dirigem at√© a loja e o carro anunciado foi vendido",
                    "‚Ä¢ Sales team gasta tempo explicando 'similar vehicles available'",
                    "‚Ä¢ Google ads budget desperdi√ßado em inventory que n√£o existe"
                ],
                "solution_specific": "Implemento: (1) Real-time inventory sync, (2) Live availability display, (3) Auto-pause ads para cars vendidos",
                "roi_specific": "Resultado: 38% redu√ß√£o em wasted leads + 29% aumento em show-up rate",
                "urgency_trigger": "End of year clearance season chegando",
                "cta": "Ver demo: inventory system real-time usado por dealer similar",
                "industry": "Automotive"
            },
            
            "credential_claims_without_verification": {
                "hook": "Prospects questionam se voc√™s s√£o realmente 'licensed & insured' como anunciam",
                "problem_specific": "Campaign credibility claims sem verification system = baixa confian√ßa. Isso significa:",
                "evidence": [
                    "‚Ä¢ Leads perguntam 'posso ver as licen√ßas?' e processo √© manual/lento",
                    "‚Ä¢ Competitors com instant verification est√£o convertendo melhor",
                    "‚Ä¢ Trust issues est√£o afetando close rate nas calls"
                ],
                "solution_specific": "Implemento: (1) Instant license verification portal, (2) Insurance status display, (3) Badge verification system",
                "roi_specific": "Resultado: 27% aumento em trust score + 33% melhoria em call-to-close rate",
                "urgency_trigger": "License renewal season (Janeiro) = oportunidade perfeita",
                "cta": "Demo 5-min: verification system usado por contractor similar",
                "industry": "Contracting"
            }
        }
    
    def generate_vulnerability_outreach(self, prospect_data: Dict, vulnerability_analysis: Dict) -> Dict:
        """
        Gera outreach hiperpersonalizado baseado na vulnerabilidade espec√≠fica detectada
        
        Args:
            prospect_data: Dados do prospect (nome, empresa, etc.)
            vulnerability_analysis: Resultado da an√°lise de vulnerabilidade
            
        Returns:
            Dict com subject, message_body, urgency_score, roi_estimate
        """
        
        # Pegar a vulnerabilidade prim√°ria (maior ROI)
        primary_insight = max(
            vulnerability_analysis.get("actionable_insights", []),
            key=lambda x: x.get("roi_potential", 0),
            default={}
        )
        
        if not primary_insight:
            return self._generate_fallback_outreach(prospect_data, vulnerability_analysis)
        
        vulnerability_type = primary_insight.get("vulnerability_type", "")
        template = self.vulnerability_templates.get(vulnerability_type, {})
        
        if not template:
            return self._generate_fallback_outreach(prospect_data, vulnerability_analysis)
        
        # PERSONALIZA√á√ïES ESPEC√çFICAS
        company_name = prospect_data.get("company_name", "sua empresa")
        contact_name = prospect_data.get("contact_name", "CEO")
        industry = template.get("industry", "empresa")
        roi_potential = primary_insight.get("roi_potential", 5000)
        
        # CONSTRUIR MENSAGEM PERSONALIZADA
        subject = f"[{company_name}] {template['hook']}"
        
        message_body = f"""Ol√° {contact_name},

{template['hook']}

{template['problem_specific']}

{chr(10).join(template['evidence'])}

üí° SOLU√á√ÉO ESPEC√çFICA:
{template['solution_specific']}

üìä ROI COMPROVADO:
{template['roi_specific']}

‚ö° URG√äNCIA: {template['urgency_trigger']}

{template['cta']}

--
Jo√£o Pedro Cardozo
ARCO Tech Optimization
Specialized in {industry} Digital Infrastructure

P.S. Tenho case study similar com {industry.lower()} company que implementou isso e aumentou ROI em 40% no primeiro m√™s."""

        return {
            "subject": subject,
            "message_body": message_body,
            "vulnerability_type": vulnerability_type,
            "roi_estimate": roi_potential,
            "urgency_score": self._calculate_urgency_score(primary_insight),
            "industry_focus": industry,
            "personalization_level": "high",
            "evidence_count": len(template["evidence"]),
            "call_to_action": template["cta"]
        }
    
    def _calculate_urgency_score(self, insight: Dict) -> int:
        """Calcula score de urg√™ncia baseado no tipo e contexto da vulnerabilidade"""
        urgency_mapping = {
            "critical": 9,
            "high": 7,
            "medium": 5,
            "low": 3
        }
        
        base_score = urgency_mapping.get(insight.get("urgency", "medium"), 5)
        
        # Ajustar baseado no ROI potential
        roi_potential = insight.get("roi_potential", 0)
        if roi_potential > 10000:
            base_score += 2
        elif roi_potential > 5000:
            base_score += 1
            
        return min(10, base_score)
    
    def _generate_fallback_outreach(self, prospect_data: Dict, vulnerability_analysis: Dict) -> Dict:
        """Template fallback quando n√£o h√° vulnerabilidade espec√≠fica detectada"""
        
        company_name = prospect_data.get("company_name", "sua empresa")
        contact_name = prospect_data.get("contact_name", "CEO")
        roi_potential = vulnerability_analysis.get("monthly_roi_potential", 5000)
        
        subject = f"[{company_name}] Detected ${roi_potential//1000}K/m√™s em optimization opportunities"
        
        message_body = f"""Ol√° {contact_name},

Analisei as campaigns de {company_name} e identifiquei ${roi_potential:,}/m√™s em optimization opportunities espec√≠ficas.

Os principais gaps detectados:
‚Ä¢ Ad campaigns com targeting inadequado para o vertical
‚Ä¢ Infrastructure gaps entre claims e delivery capability  
‚Ä¢ Conversion leaks no customer journey

Implemento solu√ß√£o espec√≠fica em 5-7 dias:
‚úì Campaign optimization baseada em industry benchmarks
‚úì Infrastructure improvement para suportar ad claims
‚úì Conversion rate optimization focada no seu vertical

ROI t√≠pico: 25-40% improvement em 30 dias.

15 min amanh√£ para mostrar analysis espec√≠fica?

--
Jo√£o Pedro Cardozo
ARCO Tech Optimization"""

        return {
            "subject": subject,
            "message_body": message_body,
            "vulnerability_type": "general_optimization",
            "roi_estimate": roi_potential,
            "urgency_score": 6,
            "industry_focus": "general",
            "personalization_level": "medium",
            "evidence_count": 3,
            "call_to_action": "15 min para analysis espec√≠fica"
        }

    def generate_followup_sequence(self, initial_outreach: Dict, days_since_send: int) -> Dict:
        """
        Gera follow-up sequence baseada na vulnerabilidade espec√≠fica
        
        Args:
            initial_outreach: Outreach inicial enviado
            days_since_send: Dias desde o envio inicial
            
        Returns:
            Dict com follow-up message espec√≠fico
        """
        
        vulnerability_type = initial_outreach.get("vulnerability_type", "")
        roi_estimate = initial_outreach.get("roi_estimate", 5000)
        industry = initial_outreach.get("industry_focus", "empresa")
        
        if days_since_send == 3:
            # FOLLOW-UP 1: Case study espec√≠fico
            return {
                "subject": f"Case study: {industry} similar aumentou ROI em 40%",
                "message_body": f"""
Quick follow-up:

Anexo case study de {industry.lower()} company com vulnerabilidade similar.

BEFORE vs AFTER:
‚Ä¢ Conversion rate: +35%
‚Ä¢ CAC reduction: -28% 
‚Ä¢ Monthly savings: ${roi_estimate:,}

Timeline: 7 dias implementation.

5 min call para mostrar approach espec√≠fico?""",
                "followup_type": "case_study",
                "urgency_score": 7
            }
            
        elif days_since_send == 7:
            # FOLLOW-UP 2: Urg√™ncia + Social proof
            return {
                "subject": f"Competitor implementou solu√ß√£o similar - timing cr√≠tico",
                "message_body": f"""
Update r√°pido:

Vi que competitor implementou infrastructure similar ao que propus.

Isso significa timing √© cr√≠tico para manter competitive advantage.

Tenho slot hoje √†s 15h ou amanh√£ √†s 10h.

Qual funciona para 10-min demo espec√≠fico?""",
                "followup_type": "competitive_urgency", 
                "urgency_score": 9
            }
            
        else:
            # FOLLOW-UP 3: Last attempt com desconto
            return {
                "subject": f"Final: ${roi_estimate//1000}K savings opportunity",
                "message_body": f"""
√öltima tentativa:

A opportunity de ${roi_estimate:,}/m√™s ainda est√° dispon√≠vel.

Para closure r√°pida: 20% desconto no implementation fee.

Reply 'SIM' se quer 5-min overview.
Reply 'N√ÉO' se n√£o √© priorit√°rio agora.

--
Jo√£o Pedro""",
                "followup_type": "final_attempt",
                "urgency_score": 6
            }
